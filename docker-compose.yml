services:
  # ─────────────────────────────────────────────
  # 스케줄러: 데이터 수집 + AI 분석 (최초 실행 시 DB 초기화 포함)
  # ─────────────────────────────────────────────
  scheduler:
    build: .
    container_name: stock-manage-scheduler
    entrypoint: ["/app/docker-entrypoint.sh"]
    command: python main.py run
    env_file: .env
    environment:
      # TZ: NAS 로컬 시간 (로그 타임스탬프용)
      # 스케줄러 내부는 America/New_York 고정 (NYSE 기준)
      TZ: ${TZ:-America/New_York}
      DATABASE_URL: sqlite:////app/data/stock_manage.db
      LOG_FILE: /app/logs/stock_manage.log
    volumes:
      # NAS 경로: .env의 DATA_PATH / LOG_PATH로 지정
      # 예) DATA_PATH=/volume1/docker/stock-manage/data
      - ${DATA_PATH:-./data}:/app/data
      - ${LOG_PATH:-./logs}:/app/logs
    restart: always
    stop_grace_period: 60s  # AI 분석 Job 완료 대기 (기본 10s → 60s)
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.5'
    healthcheck:
      test: ["CMD", "python", "-c", "import os; exit(0 if os.path.exists('/app/data/stock_manage.db') else 1)"]
      interval: 60s
      timeout: 10s
      retries: 10
      start_period: 120s  # 초기 데이터 로딩 시간 확보
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"

  # ─────────────────────────────────────────────
  # 대시보드: Streamlit UI (스케줄러 DB 초기화 완료 후 기동)
  # ─────────────────────────────────────────────
  dashboard:
    build: .
    container_name: stock-manage-dashboard
    command: >
      streamlit run dashboard/app.py
      --server.port=8085
      --server.address=0.0.0.0
      --server.headless=true
    env_file: .env
    environment:
      TZ: ${TZ:-America/New_York}
      DATABASE_URL: sqlite:////app/data/stock_manage.db
      LOG_FILE: /app/logs/stock_manage.log
      STREAMLIT_BROWSER_GATHER_USAGE_STATS: "false"
    volumes:
      - ${DATA_PATH:-./data}:/app/data
      - ${LOG_PATH:-./logs}:/app/logs
    ports:
      # NAS에서 포트 충돌 시 .env의 DASHBOARD_PORT로 변경
      - "${DASHBOARD_PORT:-8085}:8085"
    restart: always
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.5'
    depends_on:
      scheduler:
        condition: service_healthy  # scheduler DB 초기화 완료 후 기동
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"
